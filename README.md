# Spring Security Lab

A lab environment for experiments with Spring Security.

## Usage

Use `git checkout master` to reset this project back to the defaults and start a new lab. From here, create a new branch for your experiment and name it something appropriate like

```
git checkout -b jwt-lab
```

Add documentation to this README when your lab is complete.

## Labs

### http-basic

Out of the box Spring Boot uses HTTP Basic authentication. All we've done is add a resource exposed under `/resource` that returns a string

```
curl localhost:8080/resource
```

If you try to access the resource, you get

```json
{"timestamp":1512834033044,"status":401,"error":"Unauthorized","message":"Full authentication is required to access this resource","path":"/resource"}
```

The Spring Boot default is to protect all urls with HTTP Basic, so we need to pass the user name and the autogenerated password. The way to do this is to use the -u flag. Look at the log in the console for the password. You should see a line like this

```
Using default security password: 81329475-5b42-4cfc-a6a8-5172b14b7ab1
```

so we simply pass that password in with the default user name 'user':

```
curl -u user:81329475-5b42-4cfc-a6a8-5172b14b7ab1 localhost:8080/resource 
```

and you should see the string "resource" returned. Pretty boring example, but we'll get more involved as we go.

#### How Does It Work

The default Spring Boot Security configuration is described [here](https://docs.spring.io/spring-boot/docs/1.5.9.RELEASE/reference/htmlsingle/#boot-features-security).

The short answer is there is an in-memory user store that is initialized with the single user and a randomly generated password on start up. User stores in Spring Security implement the interface `UserDetailsService`, which has a single method 

#### Customizing the Autoconfigured Authentication Manager

Let's set the credentials for the single user with user name 'user'. Open the application.yml file and type security followed by tab. You will see all of the properties for configuring the default in memory user details service. For example, we can change the default user name and password with:

```yaml
security:
  user:
    name: chase
    password: changeme
```

Restart the service and try to access the resource with

```
curl -u chase:changeme localhost:8080/resource
```

#### Customizing the Protected URL Pattern

A common pattern in web services that sit directly behind web applications is to separate API requests by prefixing the url with `/api`. Suppose we do this with our service and change the route to `/api/resource`. I may only want to secure endpoints that begin with `/api` and have everything else unsecured. To do this we use the `security.basic.path` property in our application.yml:

```yaml
security:
  user:
    name: chase
    password: changeme
    
  basic:
    path:
    - "/api/**"
```

Let's add an unprotected resource under `/unprotected`. Since this doesn't start with `/api` we can access it with the usual curl command

```
curl localhost:8080/unprotected
unprotected
```

but we can't get to our `/api/resource` without authenticating as before

```
curl localhost:8080/api/resource
{"timestamp":1513019493411,"status":401,"error":"Unauthorized","message":"Full authentication is required to access this resource","path":"/api/resource"}

# try again
curl -u chase:changeme localhost:8080/api/resource
resource
```

## References

[Spring Security Reference](https://docs.spring.io/spring-security/site/docs/5.0.0.RELEASE/reference/htmlsingle/)
